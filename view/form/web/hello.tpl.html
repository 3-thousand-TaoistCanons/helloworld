<?php use \Tuanduimao\Loader\App as App; ?>

<!-- Page Content -->
<div class="content">

    <div class="block">

        <ul class="nav nav-tabs nav-tabs-alt" data-toggle="tabs">
            <li class="active">  <!-- 手机不显示 -->
                <a id="tabs-link-hello" href="#tabs-hello">创建表单</a>
            </li>
            <li>
                <a id="tabs-link-world" href="#tabs-world"  data-remote="<?=App::NR('form','hellolist')?>">操作记录</a>
            </li>
        </ul>

        <!-- TAB内容开始 -->
        <div class="block-content tab-content">

            <div class="tab-pane hide" id="tab-pane-error" >
                <div class="alert alert-danger push-50-l push-50-r push-20-t ">
                    <h3 class="font-w300 push-15">载入失败</h3>
                    <p>{HTML}</p>
                </div>
                <div class="row"  style="min-height:300px;" ></div>
            </div>

            <!-- 系统选项标签 表单 -->
            <div class="tab-pane active" id="tabs-hello">
                <div class="block-content">
                    <form id="DeptUserForm" 
                          class="js-validation-CoreHelloForm form-horizontal" 
                          action="<?=App::NR('data','hellosave')?>" method="post" >
                          
                        <div class="form-group">

                            <div class="col-lg-6">
                                <div class="form-material">
                                    <input class="form-control" type="text" id="name" name="name" value="<?=$user['name']?>" placeholder="请填写真实姓名">
                                    <label for="name">姓名</label>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="form-material">
                                    <input class="form-control" type="text" id="nick" name="nick" value="<?=$user['nick']?>" placeholder="请填写用户工号">
                                    <label for="nick">昵称</label>
                                </div>
                            </div>

                        </div>

                        <div class="form-group">
                            <div class="col-lg-12">
                                <div class="form-material">
                                    <button class="btn btn-primary HelloWorldSubmit font-w300" type="submit" name="error" > 
                                        <i class="fa fa-plus push-5-r"></i> 添加员工 
                                    </button>
                                </div>
                            </div>
                        </div>

                    </form>
                </div>
            </div>
            
            <div class="tab-pane" id="tabs-world" ></div>
        </div>
    </div>
</div>
<!-- END Page Content -->
<script type="text/javascript">


/**
 * 提交表单 
 * @param {[type]} validation [description]
 * @param {[type]} form       [description]
 */
function DataSubmit( validation, form  ) {

    var api = $(form).attr('action');
    var next = $(form).attr('data-next');
    var submits = $('button[type="submit"]', form);
        $(submits).attr('disabled', 'disabled');
        $(submits).addClass('disabled');

    var data = {};

    var formData =  $(form).serializeArray();
        for( var i=0; i<formData.length; i++ ) {
            var name = formData[i]['name'];
            var value = formData[i]['value'];

            if (value !== "") {
                data[name] = value;
            }
        }

   

    data = jQuery.extend(data, {});

    $.post( api, data, function(data, textStatus, xhr) {

        $(submits).removeAttr('disabled');
        $(submits).removeClass('disabled');

        code = data['code'] || 0;
        extra = data['extra'] || [];


        if ( typeof extra == 'object' && isNaN(extra.length) ) {
            extra = [extra];
        }



        if ( parseInt(code) == 302 ) {
            window.location.reload(true);
            return;
        }


        if ( typeof data['result'] == 'boolean' && typeof data['content'] == 'string' ) {
            
            if (  data['result'] === false ) {
                code = -1;
                extra[0] = {
                    '_FIELD':'error',
                    'message':data['content']
                };
            }
        }

        if ( code != 0 ) {

            for( i=0; i<extra.length; i++ ) {
                field = extra[i]['_FIELD'] || null;
                if ( field != null ) {
                    message = data['message'] || '出错啦';
                    if ( typeof extra[i]['message'] != 'undefined' ) {
                        message = extra[i]['message'];
                    }
                    var err = {};
                        err[field] = message;

                    validation.showErrors(err);
                }

                 App.notify( '操作失败', 'fa fa-times','danger');
            }

            return;
        }

        var message = '操作成功  ' + data['name'];

        console.log('ok', data, message );
        // 全局通知
        App.notify( message  );
        

        return;

    },'json')

    .error( function(xhr, status, statusText ){

        validation.showErrors({'error': statusText.toString()} );
             $(submits).removeAttr('disabled');
             $(submits).removeClass('disabled');
        App.notify( '操作失败', 'fa fa-times','danger');

        return;
    });
}




/**
 * 表单验证
 */
var CoreHelloForm = function() {
    var initValidation = function(){
        jQuery('.js-validation-CoreHelloForm').validate({
            errorClass: 'help-block text-right animated fadeInDown',
            errorElement: 'div',
            errorPlacement: function(error, e) {                
                jQuery(e).parents('.form-group .form-material').append(error);
            },
            highlight: function(e) {
                jQuery(e).closest('.form-group .form-material').parent().removeClass('has-error').addClass('has-error');
                jQuery(e).closest('.help-block').remove();
            },
            unhighlight:function(e){
                jQuery(e).closest('.form-group .form-material').parent().removeClass('has-error');
                jQuery(e).closest('.help-block').remove();
            },
            success: function(e) {
                jQuery(e).closest('.form-group .form-material').parent().removeClass('has-error');
                jQuery(e).closest('.help-block').remove();
            },

            submitHandler: function(form) {
                var self = this;
                DataSubmit( self, form );
            },
            rules: {

                'name': {
                    required: true,
                    minlength: 2,
                    maxlength: 20,
                },

                'nick': {
                    minlength: 2,
                    maxlength: 20,
                },
            },

            messages: {
                'name': {
                    required: '请填写姓名',
                    minlength: '姓名不能少于2个字',
                    maxlength: '姓名不能超过20个字',
                },

                'nick': {
                    minlength: '昵称不能少于2个字',
                    maxlength: '昵称不能超过20个字',
                },
            }
        });
    };

    return {
        init: function () {
            initValidation();  // Init Form Validation
        }
    };
}();

</script>

<script type="text/javascript">
$(function () {

    /** 各种数据初始化 **/

    // 表单验证程序
    CoreHelloForm.init();

});
</script>